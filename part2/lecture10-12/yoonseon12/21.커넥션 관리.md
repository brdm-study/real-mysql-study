# 21. 커넥션 관리

MySQL은 프로세스 기반으로 동작하는 다른 DBMS와 달리 스레드 기반으로 동작한다.  
덕분에 각 커넥션마다 사용하는 메모리 양이 상대적으로 낮은 편이다.

### MySQL의 커넥션 구조

- MySQL은 Thread 기반으로 동작한다.(다른 DBMS는 프로세스 기반인 경우가 많음)
- 그래서 커넥션당 메모리 사용량이 상대적으로 낮음
- 커넥션당 메모리 사용량: 16KB ~ 3MB(서비스 특성에 따라 다를 수 있음)

### 쿼리 처리 방식

- 클라이언트가 보낸 쿼리는 전용 커넥션을 통해 전달된다.
- 일부 MySQL 버전에서는 커넥션별 전용 스레드 없이 공유 Thread(쓰레드 풀) 이 쿼리를 처리한다. → 이 기능을 Thread Pool 이라고 부른다.

### 커넥션수 유의

- 커넥션당 메모리 사용량은 적지만, 커넥션 수가 매우 많아지면 문제가 될 수 있다.
- 특히 공용(MySQL 서버를 여러 서비스가 쓰는 경우) 에는 커넥션 개수 폭발에 주의해야 한다.

### 최대 커넥션수 설정(Max Connection)

- MySQL은 최대 커넥션 허용을 `max_connections` 옵션으로 관리할 수 있다.
  - 논리적으로 최대 10만개 까지 설정할 수 있음
  - 다만, 너무 많은 커넥션이 생성되면 메모리 사용량이 높아질 수 있고, 관련 자원의 사용양이 높아질 수 있음
  - 따라서 강의에서는 실제 설정될 수 있는 최대 커넥션 수가 `1~2만` 이라고 함

## 웹서버 커넥션풀

### 커넥션풀의 이점
- **성능 개선 :** 커넥션을 매번 열고 닫는 오버헤드를 줄이고 쿼리 응답 속도를 향상
- **DB 서버 과부하 방지 :** 클라이언트 요청들이 제한된 커넥션을 공유하며 MySQL 서버에 불필요한 커넥션 생성 방지

### 최대 커넥션 수

- 커넥션풀의 최대 커넥션 수는 한 번 설정한 후에는 중간에 줄이는 데 비용이 크기 때문에, 초기 설정이 매우 중요하다.   
  (단순한 서비스라면 20~30 사이에서 시작 권장)
- Spring Boot 기본 커넥션풀인 `HikariCP` 의 최대 커넥션 수 기본값은 `10`
- 최대 커넥션 수와 최소 커넥션 수를 동일하게 설정하면, 커넥션 생성 지연 없이 빠른 처리가 가능해 성능상 유리하다. 
- 그러나 항상 최대 커넥션을 유지하므로, 실제 사용량과 무관하게 커넥션이 점유되어 MySQL 서버 입장에서 리소스 부족 여부를 파악하기 어렵고 비효율적일 수 있다.

### Connection Timeout 설정

커넥션 풀에서 커넥션을 가져올 때 대기할 수 있는 최대 시간  
(가용한 커넥션이 없을 경우, 새로운 커넥션을 생성하는 데 걸리는 시간도 포함)

- 밀리초 단위 이하의 값 설정을 권장하지 않음
- 인프라 상황에 따라 3~10초 정도의 시간 설정 사용하는 것을 권장
  - 대부분의 웹 서버는 커넥션 타임아웃 발생 시 실패에 대한 별도 대응 전략이 없는 경우가 많음 
  - UX가 고려된다면, 짧은 타임아웃 설정으로 빠르게 실패하고 대안을 제공하는 것도 하나의 방법

### Query Timeout 설정

- 쿼리 타임아웃 발생 시 자동 취소나 동일 쿼리의 재요청이 발생하면, 오히려 DB 서버에 더 큰 부담을 줄 수 있음 
- 쿼리 재요청이 없도록 설계되어 있다면, 타임아웃 값을 짧게 설정하는 것도 가능

### Idle Timeout 설정

Idle 상태는 커넥션이 쿼리를 수행하지 않고 연결만 열린 상태를 의미함.  
예를 들어, 커넥션 풀에서 반환된 후, 물리적으로 연결은 살아있으나 쿼리를 실행하지 않는 상태

- 일정 시간 동안 쿼리가 실행되지 않는 Idle 커넥션을 정리하는 설정임
- 이 설정은 커넥션 풀이 오랜 시간 동안 사용되지 않은 커넥션을 자동으로 정리하여, 외부 요인으로 이미 끊어진 커넥션으로 인한 에러를 방지한다.
- **너무 짧은 Idle Timeout (0~60초)** 은 커넥션을 자주 재생성하게 되어 자원 낭비를 초래할 수 있음
- 최소 20~30분 이상 설정을 권장하며, Connection Validation 기능을 활용하고, 주요 기능에 대해 Retry 로직을 구현하는 것이 좋다.




