
MySQL 서버의 커넥션 관련된 이슈와 커넥션을 어떻게 관리해야 하는지 알아보도록 하겠습니다.
## Connection 메모리 사용량
- 일반적으로 Connection당 16KB ~ 3MB 메모리 사용
- CPU 사용량 증가

Oracle이나 PostgreSQL 서버와는 다르게 MySQL 서버는 프로세스 기반이 아닌 Thread 기반으로 동작합니다.

다른 DBMS에 대비 MySQL 서버는 각 커넥션 당 사용하는 메모리 사용량이 상대적으로 많이 낮은 편입니다. 

또한, 클라이언트가 보낸 쿼리는 전용의 커넥션을 통해 서버로 전달 되지만 일부 버전의 MySQL 서버에서는 커넥션별로 쿼리를 처리하는 `전용 Thread`가 있는 것이 아니라 `공유 Thread`가 쿼리를 처리합니다.

이러한 기능을 MySQL서버에서 `Thread Pool`이라고 하며, 각 커넥션당 사용하는 메모리는 더 효율적으로 관리될 수 있습니다.

MySQL 서버의 커넥션당 메모리 사용량은 낮은 편이긴 하지만 커넥션 개수가 많아 지는 것에  대한 주의가 필요합니다.
### Max Connection
MySQL 서버에서 최대 커넥션 개수를 설정할 수 있는 옵션이며, 최대 개수는 대략 8k ~ 10k 정도 입니다.

### Connection Pool
**Connection Pool(커넥션 풀)** 은 데이터베이스와의 연결(커넥션)을 미리 일정 개수만큼 만들어 풀(저장소)에 보관했다가, 애플리케이션에서 DB 작업이 필요할 때 커넥션을 바로 빌려서 쓰고, 사용 후 풀에 다시 반환하는 구조입니다.
#### 왜 Connection Pool이 필요한가?
1. **성능 개선** : 커넥션을 매번 새로 만들고 끊는 것보다 풀에서 대여/반납이 훨씬 빠름.
2. **DB 서버 과부하 방지** : 커넥션 수를 제어하여 DB 서버가 무한정 많은 연결로 인해 과부하에 빠지지 않도록 보호.
3. **리소스 효율성** : 애플리케이션에서 동시에 사용할 최대 커넥션수를 풀의 크기로 제한 가능.
4. **스케일 확장성** : 대량 트래픽 환경에서도 안정적인 DB 연결 유지.

#### Connection Pool 설정
- 응용 프로그램의 특성에 따라 상이하지만, `Connection Pool` 사용은 필수적이며, 시작 설정은 `Max 20 ~ 30` 로 시작하는 것이 좋습니다.

- 성능상의 이유로 `Max Connection`과 `Min Connection`을 동일한 값으로 설정하기도 하지만 앱 서버에서 커넥션이 부족한 상황인지 아닌지 예측하기가 어렵게 됩니다.

- 너무 과장된 커넥션 설정을 피하고 앱 서버의 개수를 감안하면서 커넥션 풀의 `MAX` 설정을 적당히 해주는 것이 좋습니다.

#### Connect Timeout 설정
`Connection Open` 또는 `Connection Pool`에서 `Connection` 가져오는 시간을 의미하며 `ms` 단위 이하의 값 설정을 권장하지 않습니다.

인프라 여건에 맞춰서 `3~10초` 정도의 시간 설정 사용하는 것을 권장합니다.
- `Connection`을 가져오지 못할 경우, 일반적으로 다른 Fallback 전략이 없습니다.
- 일시적인 DB 서버 과부하시, `Connection` 요청 및 취소 반복으로 오히려 부가적인 자원이 소모되게 됩니다.
- `Connection` 가져오기 실패 시, 사용자에게 오류 화면을 보내는 경우라면 `Timeout` 짧게 할 수 있습니다.

#### Idle Timeout
**IDLE**

> 현재 커넥션(또는 세션)이 데이터베이스와의 "실제 쿼리 수행 없이 연결만 열린 상태"임을 의미합니다.
> 
> 즉, 사용자가 직접 쿼리를 날리지 않고, 애플리케이션이 커넥션 풀에 커넥션을 반환했지만 물리적으로 연결이 살아 있는 경우 등을 포함합니다

일정 시간 동안 아무런 쿼리를 실행하지 않는 `UU(User-to-User) Connection`들을 정리하는 설정

해당 설정이 도입된 것은 `Connection Pool`에 오랜 시간 동안 방치되어 있던 `Connection`이 앱 서버 외부의 원인으로 인하여 이미 끊어져 버린 경우 해당 에러가 발생하게 됩니다.

해당 에러를 회피하기 위한 목적으로 너무 긴 시간동안 `IDLE` 상태인 경우 MySQL 서버도 자동으로 `Connection`을 끊어 버리게 됩니다.

하지만 에러 회피를 위해 `Idle Connection Timeout`을 매우 짧게 설정하는 것(0 ~ 60s)은 권장하지 않습니다.

MySQL서버의 `Connection`은 한 번 생성이 되면 최대한 오랜 시간 동안 재활용하는 것이 좋습니다. 

이유는, `Connection` 하나를 생성하는데 필요한 자원 소모와 `PrepareStatement`와 같이 `Connection` 하위에 캐시 되어 있는 객체들이 모두 한번에 사라지는 것을 생각하면 낭비가 너무 심해질 수도 있기 때문입니다.

최소 20~30분 이상 설정하는 것을 권장하며, 에러 회피를 위해 `Pool`의 `Connection Validation` 기능을 최대한 활용하는 것이 좋습니다. 또한 주요 기능의 경우, `Retry` 로직 구현하는 것을 권장합니다.
### Middleware (proxy)
- MySQL Router (connection Sharing)
- ProxySQL (multiplexing)
- RDS Proxy (connection pool)
#### MySQL Router (connection sharing)

이러한 기능들은 모두 앱 서버의 `Connection Pool`과 같은 기능을 `Middleware` 수준에서 제공하기 때문에 `Server-side Connection Pool` 역할을 한다고 볼 수 있습니다.

이 기능들을 활용하여 서버 사이드에서 한 번 더 커넥션을 풀링하기 때문에 실제 MySQL 서버에서 만들어지는 커넥션의 개수는 많이 줄어 들 수 있습니다.

하지만 별도의 하드웨어 및 관리 비용이 들어가며, Connection 관련 이슈가 발생하면 중간에 네트워크 홉이 생겼기 때문에 `트러블 슈팅의 난이드 증가`할 수 있습니다.

그렇기 때문에, 미들웨어의 `Server-side Connection Pooling` 기능이 필요한 경우에만 고려하는 것이 좋습니다.

#### ProxySQL (multiplexing)

`ProxySQL`에는 MySQL 서버의 도메인 네임을 IP 주소로 변환한 결과를 `일정 시간 동안 캐싱`해 두고 계속 `재활용하면서 DNS Lookup 시간을 줄여`주는 `DNS Caching` 기능이 내장되어 있습니다.

`monitor_local_dns_cache_ttl` 이라는 설정에 지정된 시간만큼 `Lookup`결과를 캐싱해두고 재사용하도록 작동합니다.

**DNS Lookup**

> 웹 브라우저, 서버, 또는 애플리케이션이 도메인 이름(example.com 등)을  
>실제 네트워크 통신에 필요한 **IP 주소(예: 142.250.206.206)** 로 변환하는 과정을 의미합니다.
>
>즉, 사람이 기억하기 쉬운 도메인(문자 주소)을 컴퓨터가 네트워크 통신에 쓸 수 있는 숫자(IP)로 바꿔주는 “주소록 조회” 행위입니다.


