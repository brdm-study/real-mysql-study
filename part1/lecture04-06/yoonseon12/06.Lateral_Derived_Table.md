# 06.Lateral Derived Table
Lateral Derived Tableì€ Derived Table(íŒŒìƒ í…Œì´ë¸”)ì˜ í•œ ì¢…ë¥˜ë‹¤.

## Lateral Derived Table ì´ë€?

- Derived Tableì€ FROM ì ˆì— ì¡´ì¬í•˜ëŠ” ì„œë¸Œì¿¼ë¦¬ë¥¼ í†µí•´ ìƒì„±ë˜ëŠ” ì„ì‹œ í…Œì´ë¸”ì„ ì˜ë¯¸í•œë‹¤.(ì¸ë¼ì¸ ë·°)
- Derived Tableì€ ì„ í–‰ í…Œì´ë¸”ì˜ ì»¬ëŸ¼ì„ ì°¸ì¡°í•  ìˆ˜ ì—†ìœ¼ë‚˜ Lateral Derived Tableì€ ì°¸ì¡°ê°€ ê°€ëŠ¥í•¨
- ì •ì˜ëœ Dervied Table ì•ë¶€ë¶„ì— `LATERAL` í‚¤ì›Œë“œë¥¼ ì¶”ê°€í•´ì„œ ì‚¬ìš©í•œë‹¤.
- ì°¸ì¡°í•œ ê°’ì„ ë°”íƒ•ìœ¼ë¡œ ë™ì ìœ¼ë¡œ ê²°ê³¼ë¥¼ ìƒì„±í•œë‹¤.

## ë™ì‘ ë°©ì‹

```sql
SELECT u.user_id, p.amount
FROM users u
LEFT JOIN LATERAL (
    SELECT amount 
    FROM payments p 
    WHERE p.user_id = u.user_id 
    ORDER BY p.created_at DESC 
    LIMIT 1
) p ON TRUE;

```

- `LATERAL`ì„ ì‚¬ìš©í•˜ë©´ **ì´ì „ í…Œì´ë¸”(`users`)ì˜ ê° í–‰ì„ ê¸°ì¤€ìœ¼ë¡œ `payments` ì„œë¸Œì¿¼ë¦¬ê°€ ì‹¤í–‰ë¨**
- `LIMIT 1`ì„ ì‚¬ìš©í•˜ì—¬ **ê° `user_id`ì— ëŒ€í•œ ê°€ì¥ ì²« ë²ˆì§¸ ê²°ì œ ê¸ˆì•¡ë§Œ ê°€ì ¸ì˜´**.
- ì¼ë°˜ `JOIN`ìœ¼ë¡œ í•´ê²°í•˜ê¸° ì–´ë ¤ìš´ **ê° í–‰ë³„ ë™ì  ì„œë¸Œì¿¼ë¦¬**ê°€ ê°€ëŠ¥í•¨.
- `ON TRUE`ë¥¼ ì‚¬ìš©í•˜ì—¬ í•­ìƒ ì°¸(`TRUE`) ì„ ëª…ì‹œí•˜ì—¬ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•´ì•¼í•¨

ğŸ’¡Â **LATERAL** í‚¤ì›Œë“œë¥¼ í†µí•´ ì„ í–‰ í…Œì´ë¸”ì˜ ì»¬ëŸ¼ì„ ì°¸ì¡°í•˜ëŠ” ê²½ìš° ê²°ê³¼ ë°ì´í„°ê°€ ì„ í–‰ í…Œì´ë¸”ì— ì˜ì¡´ì ì´ë¯€ë¡œ ì¿¼ë¦¬ ì‹¤í–‰ ì‹œ ì²˜ë¦¬ ìˆœì„œì— ì˜í–¥ì´ ìˆìŒì„ ì¸ì§€í•´ì„œ ì‚¬ìš©í•´ì•¼í•¨

### ì˜ˆì œ 1) ì¢…ì† ì„œë¸Œ ì¿¼ë¦¬ì˜ ë‹¤ì¤‘ ê°’ ë°˜í™˜

```sql
# ë¶€ì„œë³„ ê°€ì¥ ë¨¼ì € ì…ì‚¬í•œ ì§ì›ì˜ ì…ì‚¬ì¼ê³¼ ì§ì› ì´ë¦„ì„ ì¡°íšŒ
SELECT d,dept_name,
       (SELECT e.hire_date AS earliest_hire_date,
               CONCAT(e.first_name, ' ', e.last_name) AS full_name
          FROM dept_emp de
         INNER JOIN employees e ON e.emp_no = de.emp_no
         WHERE de.dept_no = d.depy_no
         ORDER BY e.hire_date LIMIT 1)
  FROM departments d
```

SELECT ì ˆì—ì„œ ì„œë¸Œì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° í•˜ë‚˜ì˜ ì»¬ëŸ¼ë§Œ ë°˜í™˜ ê°€ëŠ¥í•˜ë¯€ë¡œ ìœ„ ì¿¼ë¦¬ëŠ” ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.

ì´ ìƒí™©ì„ ê·¹ë³µí•˜ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ê°œì„ í•´ë³¸ë‹¤.

```sql
SELECT d.dept_name
       (SELECT e.hire_date
          FROM dept_emp de
         INNER JOIN employees e ON e.emp_no = de.emp_no
         WHERE de.dept_no = d.dept_no
         ORDER BY e.hire_date LIMIT 1) AS earliest_hire_date,
       (SELECT CONCAT(e.first_name, ' ', e.last_name) AS full_name
          FROM dept_emp de
         INNER JOIN emplayees e ON e.emp_no = de.emp_no
         WHERE de.dept_no = d.dept_no
         ORDER BY e.hire_date LIMIT 1) AS full_name
FROM departments d
```

í•˜ì§€ë§Œ ë™ì¼í•œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì„œë¸Œì¿¼ë¦¬ê°€ ì¤‘ë³µí•´ì„œ ì‹¤í–‰í•˜ë¯€ë¡œ ë¹„íš¨ìœ¨ì ì´ë‹¤.

ë°”ë¡œ ì´ëŸ° ê²½ìš° **LATERAL** í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

```sql
SELECT d.dept_name,
       x.earliest_hire_date,
       x.full_name
  FROM departments d
 INNER JOIN LATERAL (
       SELECT e.hire_date AS earliest_hire_date,
              CONCAT(e.first_name, ' ', e.last_name) AS full_name
         FROM dept_emp de
        INNER JOIN employees e ON e.emp_no = de.emp_no
        WHERE de.dept_no = d.dept_no
        ORDER BY e.hire_date LIMIT 1) x
```

**FROM ì ˆì—ì„œ LATERAL ë¥¼ ì‚¬ìš©í•´ í•˜ë‚˜ì˜ ì„œë¸Œì¿¼ë¦¬ë¡œ ì›í•˜ëŠ” ê°’ì„ ëª¨ë‘ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.**

- Mysql ì—ì„œ LEFT JOINì€ ON TRUE ì ˆì´ í•„ìˆ˜ì§€ë§Œ INNER JOINì€ ì„ íƒì‚¬í•­ì´ë‹¤.

### ì˜ˆì œ 2) SELECT ì ˆ ë‚´ ì—°ì‚° ê²°ê³¼ ë°˜ë³µ ì°¸ì¡°

```sql
# ì¼ë³„ ë§¤ì¶œ ë°ì´í„°ë¥¼ ì¡°íšŒ
SELECT (total_sales * margin_rate) AS profit,
       ((total_sales * margin_rate) / total_sales_number) AS avg_profit,
       (expected_sales * margin_rate) AS expected_profit,
       ((total_sales * margin_rate) / (expected_sales * margin_rate) * 100)
           AS sales_achievement_rate
  FROM daily_revenue
 WHERE sales_date = '2023-12-01';
```

SELECT ë¬¸ ë‚´ì—ì„œ ì—°ì‚° ê²°ê³¼ë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•´ ë™ì¼í•œ ì—°ì‚°ì„ ì¤‘ë³µí•´ì„œ ì‚¬ìš©í•˜ê³  ìˆë‹¤.

ìœ„ ì¿¼ë¦¬ëŠ” ê°€ë…ì„± ì¸¡ë©´ì—ì„œë„ ì¤‘ë³µëœ ì—°ì‚°ë“¤ë¡œ ì¸í•´ ë¶ˆí•„ìš”í•˜ê²Œ ì¿¼ë¦¬ê°€ ë³µì¡í•´ì ¸ ìœ ì§€ë³´ìˆ˜ì— ì¢‹ì§€ ì•Šê³  ì‹¤ìˆ˜ë¥¼ ìœ ë°œí•  ê°€ëŠ¥ì„±ë„ ë†’ë‹¤.

ì´ ìƒí™©ì„ ê·¹ë³µí•˜ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ê°œì„ í•´ë³¸ë‹¤.

```sql
SELECT profit,
       avg_profit,
       expected_profit,
       sales_achievement_rate
  FROM daily_revenue,
LATERAL (SELECT (total_sales * margin_rate) AS profit) p,
LATERAL (SELECT (profit / total_sales_number) AS avg_profit) ap,
LATERAL (SELECT (expected_sales * margin_rate) AS expected_profit) ep,
LATERAL (SELECT (profit * expected_profit * 100) AS sales_achievement_rate) sar
 WHERE sales_date = '2023-12-01';
```

FROM ì ˆì—ì„œ LATERAL í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ ì—°ì‚° ê²°ê³¼ë¥¼ ì§ì ‘ ì°¸ì¡°í•  ìˆ˜ ìˆë‹¤.

ì´ì²˜ëŸ¼ Lateral í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ë©´ ì„ í–‰ í…Œì´ë¸”ì— ëŒ€í•œ ì»¬ëŸ¼ ê°’ì„ ì°¸ì¡°í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¿¼ë¦¬ì—ì„œ ì¤‘ë³µ ì—°ì‚°ì„ ì œê±°í•˜ê³  ì¿¼ë¦¬ì˜ ê°€ë…ì„±ì„ ì¢€ ë” ë†’ì´ëŠ” ë° í™œìš©í•  ìˆ˜ ìˆë‹¤.

### ì˜ˆì œ3) TOP N ë°ì´í„° ì¡°íšŒ

```sql
CREATE TABLE creategory (
    id int NOT NULL AUTO_INCREMENT,
    name varchar(50) NOT NULL,
    PRIMARY KEY (id)
);

CREATE TABLE article (
    id int NOT NULL AUTO_INCREMENT,
    category_id int NOT NULL,
    title varchar(255) NOT NULL,
    views int NOT NULL,
    PRIMARY KEY (id),
    KEY ix_creategoryid_view (category_id, views)
);
```

```sql
# ì¹´í…Œê³ ë¦¬ë³„ ì¡°íšŒìˆ˜ê°€ ê°€ì¥ ë†’ì€ 3ê°œ ê¸°ì‚¬ ì¶”ì¶œ
SELECT x.name, x.title, x.views
  FROM (
        SELECT c.name, a.title, a.views
             , ROW_NUMBER() OVER (PARTITION BY a.category_id ORDER BY a.views DESC) AS article_rank
          FROM category c
         INNER JOIN articles a ON a.cateogry_id = c.id
) x
 WHERE x.article_rank <= 3;
  
```

ìœ„ ì¿¼ë¦¬ëŠ” Articles í…Œì´ë¸”ì„ ë¨¼ì € ì½ìœ¼ë©´ì„œ ë‚´ë¶€ì ìœ¼ë¡œ ì •ë ¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  ì´í›„ Category í…Œì´ë¸”ê³¼ ì¡°ì¸í•œë‹¤.

Articles í…Œì´ë¸”ì˜ ì „ì²´ ë°ì´í„°ë¥¼ ì½ì–´ì„œ ì²˜ë¦¬í•˜ë‹¤ ë³´ë‹ˆ ë¶ˆí•„ìš”í•˜ê²Œ ì½ëŠ” ë°ì´í„°ê°€ ë§ê³  ì´ë¡œ ì¸í•´ ì¿¼ë¦¬ê°€ ë¹„íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ ì ì§€ ì•Šì€ ì‹¤í–‰ ì‹œê°„ì´ ì†Œìš”ëœë‹¤.

ì´ ìƒí™©ì„ ê·¹ë³µí•˜ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ê°œì„ í•´ë³¸ë‹¤.

```sql
SELECT c.name, a.title, a.views
  FROM category c
 INNER JOIN LATERAL (
       SELECT category_id, title, views
         FROM articles
        WHERE category_id = c.id
        ORDER BY category_id DESC, views DESC
        LIMIT 3
 ) a
```

ê°€ë…ì„±ê³¼ ì¿¼ë¦¬ ì‘ì„± ì¸¡ë©´ì—ì„œë„ ì¢€ ë” ì§ê´€ì ì´ê³  ê°„ê²°í•œ í˜•íƒœë¡œ ì‘ì„± ê°€ëŠ¥í•˜ë‹¤.

íŠ¹íˆ ë³µì¡í•œ í˜•íƒœì˜ ë°ì´í„° ì¡°íšŒê°€ í•„ìš”í•œ ê²½ìš°ì— ê¸°ì¡´ì˜ ì¡°ì¸ì´ë‚˜ ì„œë¸Œì¿¼ë¦¬ë¥¼ Lateral Derived Tableë¥¼ ì ê·¹ í™œìš©í•˜ìâ€¦!