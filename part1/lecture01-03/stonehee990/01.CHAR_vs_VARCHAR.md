# CHAR vs. VARCHAR

저희가 작업할 때 DB 에 가장 많이 적재하는 데이터 중 하나가 문자열 타입의 데이터입니다.

이 데이터 컬럼들의 타입을 어떻게 설정하냐에 따라 성능이나 동작 방식 등이 달라질 수 있어 해당 데이터의 특징에 맞는 컬럼 타입을 설정하는 것이 무엇보다 중요합니다.

## 두 타입의 공통점
두 타입 모두 알다시피, 문자열을 저장합니다. 둘 다 `ASCII`, `UTF-8` 등 다양한 문자 인코딩 방식을 지원합니다. (다국어 가능)
그리고 타입 뒤에 컬럼의 최대 길이를 설정하도록 지정합니다. 예를 들어 `CHAR(10)`, `VARCHAR(255)` 처럼요.
그 외에도, 두 타입 모두 다양한 문자열 함수가 적용될 수 있습니다. (`LENGTH()`, `SUBSTRING()`, `CONCAT()` 등등..)

## 두 타입의 디스크 공간 사용 방식
두 타입의 차이는 디스크 공간을 사용하는 방식으로 알 수 있는데요,

### CHAR
먼저, CHAR 타입은 항상 **선언된 길이 만큼의 공간만을 사용** 합니다.
예를 들어, 타입이 `CHAR(10)` 으로 선언된 컬럼에 'abc' 라는 문자가 저장되면 실제로는 'abc'에 해당하는 값만 저장하는 것이 아닌, 빈 공간에 대한 디스크 주소도 남겨놓습니다.
즉 길이가 3글자인데도 불구하고 10글자인 데이터와 동일한 크기만큼 할당되고 사용한다는거죠.

따라서, `CHAR` 형을 사용한다면 디스크 공간을 **예측 가능하고 일정**하게 사용할 수 있는 장점이 있습니다.

### VARCHAR
VARCHAR 타입은 CHAR 타입과 달리 **실제 데이터 길이 만큼의 공간만을 사용** 합니다.
즉, CHAR 타입은 항상 고정된 크기만큼 사용했을 때와 달리, 실제 필요한 공간만을 사용하기 때문에 공간사용성이 CHAR에 비해 훨씬 우수하다는 것을 알 수 있죠.

그래서 거의 대부분의 문자열 타입을 우선 VARCHAR 로 지정하기도 하죠. (특히 제가 개발할때..)

다만, 저장된 데이터의 길이가 얼마나 되는지를 추가로 저장해야하는 `길이 정보 저장 오버헤드` 가 발생합니다. 
255바이트 미만의 데이터에 대해서는 추가로 1바이트 공간에 해당 데이터가 얼마만큼의 길이를 가지고 있는지 저장하고,  그 이상의 크기를 가진 데이터에는 2바이트 정도 공간을 추가로 할당해야합니다.
예를 들어, 타입이 `VARCHAR(10)` 으로 선언된 컬럼에 'abc' 라는 문자가 저장되면 'abc'(3바이트) + 길이 정보(1바이트) => 4바이트만큼 사용 <- 이와 같은 방식으로 동작하게 됩니다.

VARCHAR가 이렇게 효율적으로 동작하는 만큼 CHAR와 비교해서 보이게되는 단점도 분명 있습니다.
VARCHAR로 선언된 데이터가 기존 데이터보다 더 긴 문자열로 업데이트하는 경우를 생각해볼까요? 원래 있는 레코드보다 더 많은 공간을 차지해야 할테니 메모리 주소도 다시계산해서 바뀌고 이러한 작업들이 일어날 것이 상상되시나요?

실제로, MySQL에서 레코드의 크기가 변경되면 다음과 같이 동작합니다.
1. 먼저 기존 공간에 새 데이터를 저장하려고 시도합니다. 만약 새 데이터가 들어갈 수 없으면 레코드를 다른 위치로 이동시키게 됩니다.
2. 원래 위치는 비우는 것이 아닌 새 데이터의 주소로 향하는 포인터 정보를 남겨 새 위치를 가리키게 합니다.
3. 이를 `레코드 단편화(fragmentation)` 이라고 합니다.

또한 MySQL은 데이터를 페이지 단위로 저장하고 관리합니다.
VARCHAR 형식으로 선언된 데이터의 크기가 커져 기존 페이지에 들어갈 수 없게되면, 페이지 분할 현상이 일어납니다.
단순 레코드 단편화 현상이 페이지 단위로 함께 업데이트가 되게 되는 현상도 발생하는 거죠.
이런 작업은 I/O 비용도 높고 데이터베이스 성능에 직접적인 영향을 주기도 합니다.

즉 업데이트가 빈번하게 일어나는 컬럼에 VARCHAR를 사용해서 레코드 단편화가 많이 일어날 경우, MySQL에서 메모리 정리가 일어나기 전까지는 단편화 현상으로 일어나 포인터를 타고타고 들어가서 데이터를 확인하게 될 수도 있고,
그 외에도 새로운 공간으로 매번 데이터가 이동하는 것도 비용이 들게 되죠.

그럼 이러한 VARCHAR로 선언된 컬럼에 인덱스가 걸려있다면 어떨까요?
데이터 길이 변경 시 위에서 본 현상들이 일어난 것처럼 인덱스 테이블 들에도 같은 현상이 생기면서 해당 비용이 2배, 3배로 늘어날 수 잇습니다.
특히 클러스터드 인덱스가 있다면 더더욱 이러한 현상이 발생합니다.

즉 데이터 길이 변화가 적고 업데이트가 빈번한 컬럼이라면 CHAR형 타입을 사용하는 것이 유리합니다.

## CHAR와 VARCHAR에 대한 사실과 오해
강의를 보면 전화번호와 같이 고정형 길이의 데이터가 CHAR형에 적합하다는 건 오해라고합니다.
저도 그런 오해를 가지고 있었구요..!

CHAR와 VARCHAR을 선택할 때 고려할 수 있는 기준은 
데이터의 길이가 일정하거나 변경되더라도 거의 비슷한 경우 CHAR / 데이터 길이가 상대적으로 그것보다 가변적인 경우 VARCHAR
데이터가 자주 변경되는 경우 CHAR / 데이터가 상대적으로 잘 변경되지 않는 경우 VARCHAR
위와 같은 기준을 가지고 먼저 고려해볼 것 같습니다! (그 외에도 저장 길이 효율성 / 데이터의 실제 길이 / 읽기 성능 중요도 여부 등으로 후순위로 생각해볼것도 많겠네요!)

